<% max_bar = [
    @fp.gps,
    @fp.ebps,
    @fp.dh_reduced / @fp.fight_time,
    @fp.dm_reduced / @fp.fight_time,
    @fp.zm_reduced / @fp.fight_time,
    @fp.fb_reduced / @fp.fight_time
  ].max
%>

<div class="container">
  <h5><small><%= link_to @report.user_id, user_path(@report.user_id) %>&nbsp;&nbsp;>&nbsp;&nbsp;<%= link_to @report.title, report_path(@report.report_id) %>&nbsp;&nbsp;>&nbsp;&nbsp;</small><%= "#{@fight.name} (#{@fp.fight_time / 60}:#{@fp.fight_time % 60})" %></h5>

  <%= link_to('Key Metrics', '?tab=basic', class: 'button') %>
  <%= link_to('Resource Management', '?tab=resources', class: 'button') %>
  <%= link_to('Cooldown Usage', '?tab=cooldowns', class: 'button button-primary') %>
  <br /><br />

  <section>
    <h4>Guard Effectiveness</h4>
    <div class="row">
      <div class="one column"><%= @fp.fight_date %></div>
      <div class="six columns">
        <div class="bar light" style="width: <%= 100 * @fp.gps / max_bar %>%">
          <div class="bar" style="width: <%= 100 * @fp.guard_healed / (@fp.guard_absorbed + @fp.guard_healed) %>%">
            <%= @fp.gps %>/s
          </div>
        </div>
      </div>
      <div class="three columns"><%= @fp.guard_healed / 1000 %>k healed, <%= @fp.guard_absorbed / 1000 %>k absorbed</div>
    </div>
  </section>

  <section>
    <% @fp.cooldown_parses.guard.order(id: :asc).each do |guard| %>
      <div class="row" onclick="$('#g-<%= guard.id %>').slideToggle();">
      <div class="two columns u-align-right"><%= guard.time_s %> <img src="/assets/down.png" height="15px" width="15px"/></div>
      <div class="five columns">
        <div class="bar light" style="width: <%= 100 * (guard.absorbed_amount + guard.healed_amount) / @max_guard %>%">
          <div class="bar" style="width: <%= 100 * guard.healed / (guard.absorbed_amount + guard.healed_amount) rescue 0 %>%"><%= (guard.absorbed_amount + guard.healed_amount) / 1000 %>k</div>
        </div>
      </div>
      <div class="three columns"><%= guard.healed_amount / 1000 %>k healed, <%= guard.absorbed_amount / 1000 %>k absorbed</div>
    </div>
    <div id="g-<%= guard.id %>" class="row slideout">
        <div class="two columns">&nbsp;</div>
        <div class="five columns">
          <table style="width: 100%">
            <thead><tr><th>Ability</th><th>Incoming Damage</th></tr></thead>
            <tbody>
              <% guard.ability_hash.each do |ability_id, hash| %>
                <tr>
                  <td><%= hash[:name] %></td>
                  <td><%= hash[:amount] %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    <% end %>
  </section>

  <section>
    <h4>Elusive Brew Effectiveness</h4>
    <div class="row">
      <div class="one column"><%= @fp.fight_date %></div>
      <div class="six columns">
          <div class="bar" style="width: <%= 100 * @fp.ebps / max_bar %>%">
            <%= @fp.ebps %>/s
          </div>
      </div>
      <div class="three columns"><%= @fp.eb_avoided / 1000 %>k avoided</div>
    </div>
  </section>

  <section>
    <% @fp.cooldown_parses.eb.order(id: :asc).each do |eb| %>
      <div class="row" onclick="$('#eb-<%= eb.id %>').slideToggle();">
        <div class="two columns u-align-right"><%= eb.time_s %> <img src="/assets/down.png" height="15px" width="15px"/></div>
        <div class="five columns">
          <div class="bar" style="width: <%= 100 * eb.reduced_amount / @max_eb %>%"><%= eb.reduced_amount / 1000 %>k</div>
        </div>
        <div class="three columns"><%= eb.reduced_amount %> dmg / <%= eb.time %> sec</div>
      </div>
      <div id="eb-<%= eb.id %>" class="row slideout">
        <div class="two columns">&nbsp;</div>
        <div class="five columns">
          <table style="width: 100%">
            <thead><tr><th>Ability</th><th>Count</th><th>Avg. dmg.</th></tr></thead>
            <tbody>
              <% eb.ability_hash.each do |source_id, source_hash| %>
                <% source_hash[:abilities].each do |ability_id, hash| %>
                  <tr>
                    <td><%= hash[:name] %></td>
                    <td><%= hash[:dodged] %></td>
                    <td><%= hash[:avg] %></td>
                  </tr>
                <% end %>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    <% end %>
  </section>

  <% unless @fp.cooldown_parses.dh.count == 0 %>
    <section>
      <h4>Dampen Harm Effectiveness</h4>
      <div class="row">
        <div class="one column"><%= @fp.fight_date %></div>
        <div class="six columns">
            <div class="bar" style="width: <%= 100 * (@fp.dh_reduced / @fp.fight_time) / max_bar %>%">
              <%= @fp.dh_reduced / @fp.fight_time %>/s
            </div>
        </div>
        <div class="three columns"><%= @fp.dh_reduced / 1000 %>k mitigated</div>
      </div>
    </section>

    <section>
    <% @fp.cooldown_parses.dh.order(id: :asc).each do |dh| %>
      <div class="row" onclick="$('#dh-<%= dh.id %>').slideToggle();">
        <div class="two columns u-align-right"><%= dh.time_s %> <img src="/assets/down.png" height="15px" width="15px"/></div>
        <div class="five columns">
          <div class="bar" style="width: <%= 100 * dh.reduced_amount / @max_dh %>%"><%= dh.reduced_amount / 1000 %>k</div>
        </div>
        <div class="three columns"><%= dh.reduced_amount %> dmg / <%= dh.time %> sec</div>
      </div>
      <div id="dh-<%= dh.id %>" class="row slideout">
        <div class="two columns">&nbsp;</div>
        <div class="five columns">
          <table style="width: 100%">
            <thead><tr><th>Ability</th><th>Incoming damage</th></tr></thead>
            <tbody>
              <% dh.ability_hash.each do |ability_id, hash| %>
                <tr>
                  <td><%= hash[:name] %></td>
                  <td><%= hash[:inc_dmg] %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    <% end %>
  </section>
  <% end %>

  <% unless @fp.cooldown_parses.dm.count == 0 %>
    <section>
      <h4>Diffuse Magic Effectiveness</h4>
      <div class="row">
        <div class="one column"><%= @fp.fight_date %></div>
        <div class="six columns">
            <div class="bar" style="width: <%= 100 * (@fp.dm_reduced / @fp.fight_time) / max_bar %>%">
              <%= @fp.dm_reduced / @fp.fight_time %>/s
            </div>
        </div>
        <div class="three columns"><%= @fp.dm_reduced / 1000 %>k mitigated</div>
      </div>
    </section>

    <section>
    <% @fp.cooldown_parses.dm.order(id: :asc).each do |dm| %>
      <div class="row" onclick="$('#dm-<%= dm.id %>').slideToggle();">
        <div class="two columns u-align-right"><%= dm.time_s %> <img src="/assets/down.png" height="15px" width="15px"/></div>
        <div class="five columns">
          <div class="bar" style="width: <%= 100 * dm.reduced_amount / @max_dm %>%"><%= dm.reduced_amount / 1000 %>k</div>
        </div>
        <div class="three columns"><%= dm.reduced_amount %> dmg / <%= dm.time %> sec</div>
      </div>
      <div id="dm-<%= dm.id %>" class="row slideout">
        <div class="two columns">&nbsp;</div>
        <div class="five columns">
          <table style="width: 100%">
            <thead><tr><th>Ability</th><th>Incoming damage</th></tr></thead>
            <tbody>
              <% dm.ability_hash.each do |ability_id, hash| %>
                <tr>
                  <td><%= hash[:name] %></td>
                  <td><%= hash[:inc_dmg] %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    <% end %>
  </section>
  <% end %>

  <% unless @fp.cooldown_parses.zm.count == 0 %>
    <section>
      <h4>Zen Meditation Effectiveness</h4>
      <div class="row">
        <div class="one column"><%= @fp.fight_date %></div>
        <div class="six columns">
            <div class="bar" style="width: <%= 100 * (@fp.zm_reduced / @fp.fight_time) / max_bar %>%">
              <%= @fp.zm_reduced / @fp.fight_time %>/s
            </div>
        </div>
        <div class="three columns"><%= @fp.zm_reduced / 1000 %>k mitigated</div>
      </div>
    </section>

    <section>
    <% @fp.cooldown_parses.zm.order(id: :asc).each do |zm| %>
      <div class="row" onclick="$('#zm-<%= zm.id %>').slideToggle();">
        <div class="two columns u-align-right"><%= zm.time_s %> <img src="/assets/down.png" height="15px" width="15px"/></div>
        <div class="five columns">
          <div class="bar" style="width: <%= 100 * zm.reduced_amount / @max_zm %>%"><%= zm.reduced_amount / 1000 %>k</div>
        </div>
        <div class="three columns"><%= zm.reduced_amount %> zmg / <%= zm.time %> sec</div>
      </div>
      <div id="zm-<%= zm.id %>" class="row slideout">
        <div class="two columns">&nbsp;</div>
        <div class="five columns">
          <table style="width: 100%">
            <thead><tr><th>Ability</th><th>Incoming damage</th></tr></thead>
            <tbody>
              <% zm.ability_hash.each do |ability_id, hash| %>
                <tr>
                  <td><%= hash[:name] %></td>
                  <td><%= hash[:inc_dmg] %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    <% end %>
  </section>
  <% end %>

  <% unless @fp.cooldown_parses.fb.count == 0 %>
    <section>
      <h4>Fortifying Brew Effectiveness</h4>
      <div class="row">
        <div class="one column"><%= @fp.fight_date %></div>
        <div class="six columns">
            <div class="bar" style="width: <%= 100 * (@fp.fb_reduced / @fp.fight_time) / max_bar %>%">
              <%= @fp.fb_reduced / @fp.fight_time %>/s
            </div>
        </div>
        <div class="three columns"><%= @fp.fb_reduced / 1000 %>k mitigated</div>
      </div>
    </section>

    <section>
    <% @fp.cooldown_parses.fb.order(id: :asc).each do |fb| %>
      <div class="row" onclick="$('#fb-<%= fb.id %>').slideToggle();">
        <div class="two columns u-align-right"><%= fb.time_s %> <img src="/assets/down.png" height="15px" width="15px"/></div>
        <div class="five columns">
          <div class="bar" style="width: <%= 100 * fb.reduced_amount / @max_fb %>%"><%= fb.reduced_amount / 1000 %>k</div>
        </div>
        <div class="three columns"><%= fb.reduced_amount %> fbg / <%= fb.time %> sec</div>
      </div>
      <div id="fb-<%= fb.id %>" class="row slideout">
        <div class="two columns">&nbsp;</div>
        <div class="five columns">
          <table style="width: 100%">
            <thead><tr><th>Ability</th><th>Incoming damage</th></tr></thead>
            <tbody>
              <% fb.ability_hash.each do |ability_id, hash| %>
                <tr>
                  <td><%= hash[:name] %></td>
                  <td><%= hash[:inc_dmg] %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    <% end %>
  </section>
  <% end %>
</div>